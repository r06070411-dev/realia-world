<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>REALIA WORLD (Demo)</title>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; background:#0b1020; }
    #ui {
      position: fixed; left: 12px; top: 12px; z-index: 10;
      display: flex; gap: 8px; flex-wrap: wrap;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
    }
    .chip {
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      color: #fff; padding: 8px 10px; border-radius: 10px;
      font-size: 13px; backdrop-filter: blur(10px);
      display: inline-flex; align-items: center; gap: 8px;
    }
    .chip b { font-weight: 700; }
    .btn {
      cursor: pointer; user-select: none;
      background: rgba(129, 86, 255, .25);
      border: 1px solid rgba(129, 86, 255, .55);
    }
    #hint {
      position: fixed; left: 12px; bottom: 12px; z-index: 10;
      color: rgba(255,255,255,.85); font-size: 13px; line-height: 1.5;
      background: rgba(0,0,0,.25); padding: 10px 12px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12); backdrop-filter: blur(10px);
      max-width: min(540px, calc(100vw - 24px));
    }
    #panel {
      position: fixed; right: 12px; top: 12px; z-index: 20;
      width: min(360px, calc(100vw - 24px));
      background: rgba(10,12,20,.72);
      border: 1px solid rgba(255,255,255,.14);
      color: #fff; border-radius: 14px; overflow: hidden;
      backdrop-filter: blur(14px);
      display: none;
    }
    #panel header {
      padding: 12px 14px; display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    #panel header .x {
      cursor: pointer; padding: 6px 10px; border-radius: 10px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
    }
    #panel .body { padding: 12px 14px; font-size: 14px; line-height: 1.6; }
    #panel .body .row { margin: 8px 0; opacity: .95; }
    #panel a { color: #bda6ff; text-decoration: none; }
    #panel a:hover { text-decoration: underline; }

    /* 簡易バーチャルスティック（スマホ用） */
    #stickWrap {
      position: fixed; left: 12px; bottom: 98px; z-index: 15;
      width: 140px; height: 140px; border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      display: none;
      touch-action: none;
    }
    #stick {
      position: absolute; left: 50%; top: 50%;
      width: 54px; height: 54px; margin-left: -27px; margin-top: -27px;
      border-radius: 999px;
      background: rgba(129, 86, 255, .35);
      border: 1px solid rgba(129, 86, 255, .6);
    }
    #lookHint {
      position: fixed; left: 12px; bottom: 66px; z-index: 15;
      color: rgba(255,255,255,.8);
      font-size: 12px;
      background: rgba(0,0,0,.22);
      padding: 8px 10px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      display: none;
    }
  </style>
</head>
<body>
  <div id="ui">
    <div class="chip"><b>REALIA WORLD</b> Demo</div>
    <div id="fps" class="chip">FPS: --</div>
    <div id="pos" class="chip">POS: --</div>
    <div id="mode" class="chip btn">操作: PC/スマホ自動</div>
  </div>

  <div id="panel">
    <header>
      <div id="pTitle" style="font-weight:700;">店舗情報</div>
      <div class="x" id="pClose">閉じる</div>
    </header>
    <div class="body">
      <div class="row" id="pDesc"></div>
      <div class="row"><b>予算目安:</b> <span id="pBudget"></span></div>
      <div class="row"><b>対応:</b> <span id="pTags"></span></div>
      <div class="row"><b>問い合わせ:</b> <a id="pLink" href="#" target="_blank" rel="noreferrer">開く</a></div>
    </div>
  </div>

  <div id="stickWrap"><div id="stick"></div></div>
  <div id="lookHint">画面をドラッグで視点移動 / 左の丸で移動</div>

  <div id="hint">
    <b>操作</b><br>
    PC: <b>WASD</b>移動 / マウスドラッグで視点 / 建物クリックで情報<br>
    スマホ: 画面ドラッグで視点 / 左スティックで移動 / タップで建物選択
  </div>

  <!-- Three.js (module) -->
  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.161.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.161.0/examples/jsm/controls/OrbitControls.js";

    // ===== デモ用「店舗データ」(のちにDB/Supabaseに置き換える) =====
    const SHOPS = [
      {
        id: "shop_001",
        name: "碧リフォーム",
        desc: "外壁塗装・屋根塗装。地域密着。スピード見積もり。",
        budget: "100万円〜",
        tags: ["外壁", "屋根", "防水", "最短見積"],
        url: "https://example.com/inquiry?shop=aoi"
      },
      {
        id: "shop_002",
        name: "福翔工務店",
        desc: "リフォーム全般。現地調査→提案までワンストップ。",
        budget: "80万円〜",
        tags: ["リフォーム", "内装", "水回り"],
        url: "https://example.com/inquiry?shop=fukusho"
      },
      {
        id: "shop_003",
        name: "サンプル不動産",
        desc: "土地・中古・投資用。物件提案をワールド内で。",
        budget: "要相談",
        tags: ["不動産", "投資", "物件紹介"],
        url: "https://example.com/inquiry?shop=estate"
      }
    ];

    // ===== 基本セットアップ =====
    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x0b1020, 40, 220);

    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0, 10, 22);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    document.body.appendChild(renderer.domElement);

    // ライト
    const hemi = new THREE.HemisphereLight(0x9fb7ff, 0x101322, 0.9);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(18, 30, 12);
    dir.castShadow = false;
    scene.add(dir);

    // 地面
    const groundGeo = new THREE.PlaneGeometry(400, 400);
    const groundMat = new THREE.MeshStandardMaterial({
      color: 0x111a33,
      metalness: 0.15,
      roughness: 0.85
    });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.position.y = 0;
    scene.add(ground);

    // グリッド（街っぽさ）
    const grid = new THREE.GridHelper(200, 50, 0x4a5cff, 0x1b2a55);
    grid.material.opacity = 0.25;
    grid.material.transparent = true;
    scene.add(grid);

    // 遠景の塔（雰囲気）
    function addTower(x,z,h=30){
      const g = new THREE.CylinderGeometry(1.2, 1.6, h, 18);
      const m = new THREE.MeshStandardMaterial({ color: 0x2b3a7a, metalness: 0.4, roughness: 0.4 });
      const t = new THREE.Mesh(g,m);
      t.position.set(x, h/2, z);
      scene.add(t);
    }
    addTower(-45, -30, 28);
    addTower(55,  35, 34);
    addTower(10, -60, 26);

    // カメラ操作（Orbit）
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.target.set(0, 4, 0);
    controls.maxPolarAngle = Math.PI * 0.49;
    controls.minDistance = 6;
    controls.maxDistance = 80;

    // ===== プレイヤー（見えないカメラ移動） =====
    const player = {
      pos: new THREE.Vector3(0, 0, 18),
      vel: new THREE.Vector3(),
      speed: 12,
      stick: { x: 0, y: 0 }
    };

    // ===== 建物生成（クリック対象） =====
    const clickable = [];
    const buildingMat = new THREE.MeshStandardMaterial({ color: 0x7b5cff, metalness: 0.55, roughness: 0.35 });
    const accentMat   = new THREE.MeshStandardMaterial({ color: 0xffffff, metalness: 0.2, roughness: 0.7 });

    function makeBuilding(shop, x, z, w=4, d=4, h=8){
      const group = new THREE.Group();
      const base = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), buildingMat);
      base.position.y = h/2;
      group.add(base);

      // 屋上アクセント
      const top = new THREE.Mesh(new THREE.BoxGeometry(w*0.9, 0.4, d*0.9), accentMat);
      top.position.y = h + 0.2;
      top.material.opacity = 0.85;
      top.material.transparent = true;
      group.add(top);

      // ネームプレート（簡易）
      const plate = new THREE.Mesh(new THREE.BoxGeometry(w*0.9, 0.9, 0.15), accentMat);
      plate.position.set(0, h*0.65, d/2 + 0.1);
      plate.material.opacity = 0.28;
      plate.material.transparent = true;
      group.add(plate);

      group.position.set(x, 0, z);
      group.userData.shop = shop;
      scene.add(group);

      clickable.push(base);      // クリックはベースで拾う
      base.userData.shop = shop; // 情報持たせる
      return group;
    }

    // 街っぽく配置
    makeBuilding(SHOPS[0], -10,  0, 5, 5, 10);
    makeBuilding(SHOPS[1],  10, -6, 6, 4,  9);
    makeBuilding(SHOPS[2],   4, 10, 4, 6, 12);

    // 追加のダミービル群
    for(let i=0;i<18;i++){
      const x = (Math.random()*2-1)*45;
      const z = (Math.random()*2-1)*45;
      if (Math.abs(x)<16 && Math.abs(z)<16) continue;
      const w = 2.5 + Math.random()*4;
      const d = 2.5 + Math.random()*4;
      const h = 4   + Math.random()*16;
      const m = new THREE.MeshStandardMaterial({
        color: new THREE.Color().setHSL(0.65, 0.55, 0.22 + Math.random()*0.20),
        metalness: 0.25 + Math.random()*0.35,
        roughness: 0.35 + Math.random()*0.45
      });
      const b = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), m);
      b.position.set(x, h/2, z);
      scene.add(b);
    }

    // ===== UI: 店舗パネル =====
    const panel = document.getElementById("panel");
    const pTitle = document.getElementById("pTitle");
    const pDesc  = document.getElementById("pDesc");
    const pBudget= document.getElementById("pBudget");
    const pTags  = document.getElementById("pTags");
    const pLink  = document.getElementById("pLink");
    document.getElementById("pClose").onclick = () => panel.style.display = "none";

    function openShop(shop){
      pTitle.textContent = shop.name;
      pDesc.textContent  = shop.desc;
      pBudget.textContent= shop.budget;
      pTags.textContent  = shop.tags.join(" / ");
      pLink.href         = shop.url;
      panel.style.display = "block";
    }

    // ===== レイキャスト（クリック判定） =====
    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();

    function onPointerDown(ev){
      const x = (ev.clientX / innerWidth) * 2 - 1;
      const y = -(ev.clientY / innerHeight) * 2 + 1;
      pointer.set(x,y);
      raycaster.setFromCamera(pointer, camera);
      const hits = raycaster.intersectObjects(clickable, false);
      if(hits.length){
        const shop = hits[0].object.userData.shop;
        if(shop) openShop(shop);
      }
    }
    window.addEventListener("pointerdown", onPointerDown);

    // ===== 移動：PC(WASD) + スマホ(スティック) =====
    const keys = { w:false,a:false,s:false,d:false };
    window.addEventListener("keydown", (e)=>{
      if(e.key==="w"||e.key==="W") keys.w=true;
      if(e.key==="a"||e.key==="A") keys.a=true;
      if(e.key==="s"||e.key==="S") keys.s=true;
      if(e.key==="d"||e.key==="D") keys.d=true;
    });
    window.addEventListener("keyup", (e)=>{
      if(e.key==="w"||e.key==="W") keys.w=false;
      if(e.key==="a"||e.key==="A") keys.a=false;
      if(e.key==="s"||e.key==="S") keys.s=false;
      if(e.key==="d"||e.key==="D") keys.d=false;
    });

    const isMobile = matchMedia("(pointer:coarse)").matches;
    const stickWrap = document.getElementById("stickWrap");
    const stick = document.getElementById("stick");
    const lookHint = document.getElementById("lookHint");
    const mode = document.getElementById("mode");
    if(isMobile){
      stickWrap.style.display = "block";
      lookHint.style.display = "block";
      mode.textContent = "操作: スマホ";
    } else {
      mode.textContent = "操作: PC";
    }

    // スティック制御
    let draggingStick = false;
    let stickCenter = { x:0, y:0 };
    function setStick(nx, ny){
      player.stick.x = nx;
      player.stick.y = ny;
      const max = 42;
      stick.style.transform = `translate(${nx*max}px, ${ny*max}px)`;
    }
    function resetStick(){ setStick(0,0); }

    stickWrap.addEventListener("pointerdown", (e)=>{
      draggingStick = true;
      const r = stickWrap.getBoundingClientRect();
      stickCenter = { x: r.left + r.width/2, y: r.top + r.height/2 };
      stickWrap.setPointerCapture(e.pointerId);
    });
    stickWrap.addEventListener("pointermove", (e)=>{
      if(!draggingStick) return;
      const dx = e.clientX - stickCenter.x;
      const dy = e.clientY - stickCenter.y;
      const max = 52;
      const nx = THREE.MathUtils.clamp(dx/max, -1, 1);
      const ny = THREE.MathUtils.clamp(dy/max, -1, 1);
      setStick(nx, ny);
    });
    stickWrap.addEventListener("pointerup", ()=>{
      draggingStick = false;
      resetStick();
    });

    // ===== ループ =====
    let last = performance.now();
    let fpsAcc=0, fpsN=0;

    const fpsEl = document.getElementById("fps");
    const posEl = document.getElementById("pos");

    function animate(now){
      requestAnimationFrame(animate);
      const dt = Math.min((now-last)/1000, 0.033);
      last = now;

      // 入力ベクトル
      let ix = 0, iz = 0;
      if(keys.w) iz -= 1;
      if(keys.s) iz += 1;
      if(keys.a) ix -= 1;
      if(keys.d) ix += 1;

      // スマホスティック（前が-、右が+）
      ix += player.stick.x;
      iz += player.stick.y;

      // 正規化
      const len = Math.hypot(ix, iz);
      if(len > 1e-3){
        ix/=len; iz/=len;
      }

      // カメラの向きに沿って移動（視点方向前後左右）
      const forward = new THREE.Vector3();
      camera.getWorldDirection(forward);
      forward.y = 0; forward.normalize();
      const right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0,1,0)).normalize();

      const move = new THREE.Vector3()
        .addScaledVector(right, ix)
        .addScaledVector(forward, iz)
        .multiplyScalar(player.speed * dt);

      player.pos.add(move);

      // 範囲制限
      player.pos.x = THREE.MathUtils.clamp(player.pos.x, -90, 90);
      player.pos.z = THREE.MathUtils.clamp(player.pos.z, -90, 90);

      // OrbitControlsのターゲットをプレイヤー位置へ
      controls.target.lerp(new THREE.Vector3(player.pos.x, 3.5, player.pos.z), 0.12);

      // カメラもターゲット中心に“ついていく”感じに
      // (OrbitControlsがカメラ位置を保持するので、targetだけ追従でOK)

      controls.update();
      renderer.render(scene, camera);

      // 表示
      fpsAcc += 1/dt; fpsN++;
      if(fpsN >= 10){
        fpsEl.textContent = "FPS: " + Math.round(fpsAcc/fpsN);
        fpsAcc=0; fpsN=0;
      }
      posEl.textContent = `POS: ${player.pos.x.toFixed(1)}, ${player.pos.z.toFixed(1)}`;
    }
    requestAnimationFrame(animate);

    // リサイズ
    addEventListener("resize", ()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>
