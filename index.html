<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>REALIA WORLD (Demo)</title>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#05070d; }
    canvas { display:block; }
    #ui{
      position:fixed; left:12px; top:12px; z-index:10;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
    }
    .chip{
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color:#fff; padding:8px 12px; border-radius:12px;
      font-size:13px; backdrop-filter: blur(10px);
    }
    .btn{
      cursor:pointer; user-select:none;
      background:rgba(129,86,255,.25);
      border:1px solid rgba(129,86,255,.55);
    }
    #hint{
      position:fixed; left:12px; bottom:12px; z-index:10;
      color:rgba(255,255,255,.85); font-size:13px;
      background:rgba(0,0,0,.25); padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      max-width:min(560px, calc(100vw - 24px));
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
      line-height:1.5;
    }
    #panel{
      position:fixed; right:12px; top:12px; z-index:10;
      width:min(360px, calc(100vw - 24px));
      background:rgba(12,20,40,.72);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      color:#fff;
      padding:12px 12px 10px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
      backdrop-filter: blur(10px);
      display:none;
    }
    #panel h3{ margin:0 0 6px; font-size:14px; opacity:.9; }
    #panel p{ margin:0; font-size:13px; opacity:.9; line-height:1.5; }
    #close{
      float:right; cursor:pointer; opacity:.85;
      padding:2px 8px; border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
    }
    #touchControls{
      position:fixed; left:12px; bottom:92px; z-index:10;
      display:flex; gap:10px; align-items:center;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
      user-select:none;
    }
    .stickBase{
      width:110px; height:110px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      position:relative;
      touch-action:none;
    }
    .stickKnob{
      width:46px; height:46px; border-radius:999px;
      background:rgba(129,86,255,.35);
      border:1px solid rgba(129,86,255,.65);
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
    }
    .tapBtn{
      width:110px; height:46px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      color:#fff; font-size:13px;
      touch-action:manipulation;
    }
    @media (pointer:fine){
      #touchControls{ display:none; }
    }
  </style>
</head>
<body>
  <div id="ui">
    <div class="chip"><b>REALIA WORLD</b> Demo</div>
    <div class="chip">FPS: <span id="fps">--</span></div>
    <div class="chip">POS: <span id="pos">--</span></div>
    <div class="chip btn" id="toggleMode">操作: PC/スマホ自動</div>
  </div>

  <div id="panel">
    <span id="close">閉じる</span>
    <h3>建物情報</h3>
    <p id="panelText">建物をタップ/クリックすると情報が出ます。</p>
  </div>

  <div id="touchControls">
    <div class="stickBase" id="stick">
      <div class="stickKnob" id="knob"></div>
    </div>
    <div class="tapBtn" id="jumpBtn">ジャンプ</div>
  </div>

  <div id="hint">
    <b>操作</b><br/>
    PC: <b>WASD</b>移動 / マウスドラッグで視点 / 建物クリックで情報<br/>
    スマホ: 画面ドラッグで視点 / 左スティックで移動 / タップで建物選択
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>
  <script>
    // ===== 基本セットアップ =====
    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x05070d, 20, 220);

    const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0, 3, 10);

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // ===== ライト =====
    const hemi = new THREE.HemisphereLight(0xaac7ff, 0x0b1020, 0.9);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(25, 40, 15);
    dir.castShadow = true;
    dir.shadow.mapSize.set(1024, 1024);
    scene.add(dir);

    // ===== 地面 =====
    const groundGeo = new THREE.PlaneGeometry(600, 600, 60, 60);
    const groundMat = new THREE.MeshStandardMaterial({
      color: 0x0b1020, metalness:0.1, roughness:0.9
    });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;
    scene.add(ground);

    // グリッド（薄く表示）
    const grid = new THREE.GridHelper(600, 120, 0x3b4a7a, 0x1a2342);
    grid.material.opacity = 0.18;
    grid.material.transparent = true;
    scene.add(grid);

    // ===== 道（簡易） =====
    const roadMat = new THREE.MeshStandardMaterial({ color:0x0f162d, roughness:0.8, metalness:0.0 });
    function addRoad(x, z, w, h){
      const m = new THREE.Mesh(new THREE.BoxGeometry(w, 0.12, h), roadMat);
      m.position.set(x, 0.06, z);
      m.receiveShadow = true;
      scene.add(m);
    }
    addRoad(0, 0, 18, 4);
    addRoad(-10, -8, 4, 16);
    addRoad(12, 10, 20, 4);

    // ===== 建物（クリックで情報） =====
    const pickables = [];
    const buildingMatA = new THREE.MeshStandardMaterial({ color:0x6b7cff, roughness:0.35, metalness:0.25 });
    const buildingMatB = new THREE.MeshStandardMaterial({ color:0x9b7bff, roughness:0.35, metalness:0.25 });
    const roofMat = new THREE.MeshStandardMaterial({ color:0x0c0f1a, roughness:0.8, metalness:0.0 });

    function addBuilding(name, info, x, z, w, d, h, mat){
      const body = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), mat);
      body.position.set(x, h/2, z);
      body.castShadow = true;
      body.userData = { name, info };
      scene.add(body);
      pickables.push(body);

      // 屋根
      const roof = new THREE.Mesh(new THREE.BoxGeometry(w*1.02, 0.3, d*1.02), roofMat);
      roof.position.set(x, h + 0.15, z);
      roof.castShadow = true;
      scene.add(roof);

      // 簡易看板（発光っぽい）
      const sign = new THREE.Mesh(
        new THREE.PlaneGeometry(Math.min(w, d)*0.9, 0.8),
        new THREE.MeshBasicMaterial({ color:0xffffff, transparent:true, opacity:0.9 })
      );
      sign.position.set(x, h*0.65, z + d/2 + 0.01);
      scene.add(sign);
    }

    addBuilding("加盟店A", "外壁塗装・屋根塗装対応 / 最短即日見積もり", -6, -2, 3.2, 3.2, 4.5, buildingMatA);
    addBuilding("加盟店B", "内装・水回りリフォーム / 分割払いOK", 6, 2, 4.0, 3.0, 6.0, buildingMatB);
    addBuilding("モデルルーム", "3Dワールドのデモ物件 / タップで情報表示", 12, 10, 5.5, 4.0, 5.0, buildingMatA);
    addBuilding("案内所", "ここからワールドを拡張できます（地形/建物/道路）", -10, -10, 4.0, 4.0, 3.5, buildingMatB);

    // 目印タワー
    const tower = new THREE.Mesh(
      new THREE.CylinderGeometry(0.8, 1.1, 16, 24),
      new THREE.MeshStandardMaterial({ color:0x2cf3ff, roughness:0.25, metalness:0.4 })
    );
    tower.position.set(0, 8, -18);
    tower.castShadow = true;
    scene.add(tower);

    // ===== カメラ操作（簡易FPS風） =====
    let yaw = 0, pitch = 0;
    const rotSpeed = 0.0022;

    const keys = { w:false,a:false,s:false,d:false, shift:false };
    addEventListener('keydown', (e)=>{
      if(e.key === 'w') keys.w = true;
      if(e.key === 'a') keys.a = true;
      if(e.key === 's') keys.s = true;
      if(e.key === 'd') keys.d = true;
      if(e.key === 'Shift') keys.shift = true;
    });
    addEventListener('keyup', (e)=>{
      if(e.key === 'w') keys.w = false;
      if(e.key === 'a') keys.a = false;
      if(e.key === 's') keys.s = false;
      if(e.key === 'd') keys.d = false;
      if(e.key === 'Shift') keys.shift = false;
    });

    let dragging = false;
    let lastX = 0, lastY = 0;

    function startDrag(x,y){ dragging=true; lastX=x; lastY=y; }
    function moveDrag(x,y){
      if(!dragging) return;
      const dx = x - lastX, dy = y - lastY;
      lastX = x; lastY = y;
      yaw   -= dx * rotSpeed;
      pitch -= dy * rotSpeed;
      pitch = Math.max(-1.2, Math.min(1.2, pitch));
    }
    function endDrag(){ dragging=false; }

    // マウス
    addEventListener('mousedown', (e)=> startDrag(e.clientX, e.clientY));
    addEventListener('mousemove', (e)=> moveDrag(e.clientX, e.clientY));
    addEventListener('mouseup', endDrag);

    // タッチ
    addEventListener('touchstart', (e)=>{
      if(e.touches.length===1){
        startDrag(e.touches[0].clientX, e.touches[0].clientY);
      }
    }, {passive:true});
    addEventListener('touchmove', (e)=>{
      if(e.touches.length===1){
        moveDrag(e.touches[0].clientX, e.touches[0].clientY);
      }
    }, {passive:true});
    addEventListener('touchend', endDrag, {passive:true});

    // ===== スマホ左スティック =====
    const stick = document.getElementById('stick');
    const knob  = document.getElementById('knob');
    let stickActive = false;
    let stickVec = {x:0,y:0}; // -1..1

    function setKnob(px, py){
      const r = 40; // 最大移動
      const len = Math.hypot(px, py);
      let x = px, y = py;
      if(len > r){ x = px/len*r; y = py/len*r; }
      knob.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      stickVec.x = x/r;
      stickVec.y = y/r;
    }
    function resetKnob(){
      knob.style.transform = `translate(-50%,-50%)`;
      stickVec.x = 0; stickVec.y = 0;
    }

    stick.addEventListener('touchstart', (e)=>{
      stickActive = true;
      const rect = stick.getBoundingClientRect();
      const t = e.touches[0];
      setKnob(t.clientX - (rect.left + rect.width/2), t.clientY - (rect.top + rect.height/2));
    }, {passive:false});

    stick.addEventListener('touchmove', (e)=>{
      if(!stickActive) return
